<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>BSPTree.as</title>
<link rel="stylesheet" type="text/css" href="../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">graphs</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">bsp</span><span class="ActionScriptBracket/Brace">{</span>    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">arcane</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">cameras</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">cameras</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lenses</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">containers</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">core</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">base</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">core</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">geom</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">core</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">render</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">core</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">traverse</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">core</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">utils</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">events</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">materials</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;        <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">geom</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">utils</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">use</span> <span class="ActionScriptReserved">namespace</span> <span class="ActionScriptDefault_Text">arcane</span>;        <span class="ActionScriptASDoc">/**     * BSPTree is a scene graph structure that allows static scenes to be rendered without z-sorting or z-conflicts,     * and performs early culling to remove big parts of the geometry that don't need to be rendered. It also speeds up various tasks such as     * collision detection.     */</span>    <span class="ActionScriptComment">// TO DO: Move all build functionality to a wrapper!</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">BSPTree</span> <span class="ActionScriptReserved">extends</span> <span class="ActionScriptDefault_Text">ObjectContainer3D</span>    <span class="ActionScriptBracket/Brace">{</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">TEST_METHOD_POINT</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">TEST_METHOD_AABB</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 1;        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">TEST_METHOD_ELLIPSOID</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 2;        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">EPSILON</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0.07;        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">COLLISION_EPSILON</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0.1;                <span class="ActionScriptComment">// indicates whether or not to use the potentially visible set for culling</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">usePVS</span> : <span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                <span class="ActionScriptComment">// the root node in the tree</span>        <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_rootNode</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;                <span class="ActionScriptComment">// a list of all leafs in the tree, for fast access</span>        <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_leaves</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">&gt;</span>;                <span class="ActionScriptComment">// the leaf which currently contains the camera</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_activeLeaf</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;                <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_transformPt</span> : <span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_viewToLocal</span> : <span class="ActionScriptDefault_Text">Matrix3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Matrix3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptComment">// used for correct rendering and pre-culling</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_cameraVarsStore</span> : <span class="ActionScriptDefault_Text">CameraVarsStore</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_dynamics</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Object3D</span><span class="ActionScriptBracket/Brace">&gt;</span>;                <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_renderMark</span> : <span class="ActionScriptDefault_Text">int</span>;                <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_obbCollisionTree</span> : <span class="ActionScriptDefault_Text">BSPTree</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_meshManagers</span> : <span class="ActionScriptDefault_Text">Dictionary</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_complete</span> : <span class="ActionScriptDefault_Text">Boolean</span>;        <span class="ActionScriptComment">// traversal </span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 1;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 2;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_state</span> : <span class="ActionScriptDefault_Text">int</span>;                <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_faces</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Face</span><span class="ActionScriptBracket/Brace">&gt;</span>;        <span class="ActionScriptASDoc">/**         * Creates a new BSPTree object.         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">BSPTree</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buildDynamicCollisionTree</span> : <span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">super</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">_leaves</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">_dynamics</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Object3D</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">_preCulled</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;            <span class="ActionScriptDefault_Text">_rootNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">name</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">"root"</span>;            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">buildDynamicCollisionTree</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">buildCollisionTree</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">rootNode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">BSPNode</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_rootNode</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">buildCollisionTree</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span> : <span class="ActionScriptDefault_Text">int</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">node</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptDefault_Text">_obbCollisionTree</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPTree</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_obbCollisionTree</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_rootNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptReserved">do</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">node</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> 5<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">node</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> 6<span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptASDoc">/**         * The leaf containing the camera. Returns null if the camera is in "solid" space.         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">activeLeaf</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">BSPNode</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_activeLeaf</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptASDoc">/**         * All the leaves in the current tree         */</span>        <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">leaves</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">&gt;</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_leaves</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptASDoc">/**         * @inheritDoc         * Ensure correct renderer is set when it's added         */</span>        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">set</span> <span class="ActionScriptDefault_Text">parent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">value</span>:<span class="ActionScriptDefault_Text">ObjectContainer3D</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptDefault_Text">ownCanvas</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;            <span class="ActionScriptDefault_Text">renderer</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPRenderer</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptReserved">super</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">parent</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">value</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * Finds the leaf that contains a given point         *          * @param point The point to be traced. The point is expressed in local space.         * @param quitOnCulled Indicates whether leaf finding should stop when a culled node is encountered.         * @return The leaf containing the point         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getLeafContaining</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">point</span> : <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">quitOnCulled</span> : <span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">BSPNode</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">node</span> : <span class="ActionScriptDefault_Text">BSPNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dot</span> : <span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">plane</span> : <span class="ActionScriptDefault_Text">Plane3D</span>;                        <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span><span class="ActionScriptBracket/Brace">)</span>            <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">quitOnCulled</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;                <span class="ActionScriptDefault_Text">plane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;                <span class="ActionScriptDefault_Text">dot</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">point</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">point</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">+</span><span class="ActionScriptDefault_Text">point</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span>;                <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">dot</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span><span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span> : <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;            <span class="ActionScriptBracket/Brace">}</span>                         <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">node</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * Updates the tree's state. This method is called before the first traversal.         * Performs early culling and ordering of nodes.         *          * @private         */</span>        <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">update</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">camera</span> : <span class="ActionScriptDefault_Text">Camera3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">frustum</span> : <span class="ActionScriptDefault_Text">Frustum</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">cameraVarsStore</span> : <span class="ActionScriptDefault_Text">CameraVarsStore</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">camera</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">lens</span> <span class="ActionScriptReserved">is</span> <span class="ActionScriptDefault_Text">PerspectiveLens</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>                <span class="ActionScriptReserved">throw</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"Lens is of incorrect type! BSP needs a PerspectiveLens instance assigned to Camera3D.lens"</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">_complete</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>;                        <span class="ActionScriptComment">// force transform updates</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_dynamics</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;            <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">--</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&gt;=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">_dynamics</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">sceneTransform</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">invSceneTransform</span> : <span class="ActionScriptDefault_Text">Matrix3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">inverseSceneTransform</span>;                        <span class="ActionScriptComment">// get frustum for local coordinate system</span>            <span class="ActionScriptDefault_Text">_viewToLocal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">rawData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">invSceneTransform</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">rawData</span>;            <span class="ActionScriptDefault_Text">_viewToLocal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">prepend</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">camera</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transform</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptComment">// transform camera into local coordinate system</span>            <span class="ActionScriptDefault_Text">_transformPt</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">invSceneTransform</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transformVector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">camera</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptComment">// figure out leaf containing the point</span>            <span class="ActionScriptDefault_Text">_activeLeaf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">getLeafContaining</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_transformPt</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptComment">//            if (!freezeCulling)</span>            <span class="ActionScriptDefault_Text">doCulling</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_activeLeaf</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">frustum</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">_renderMark</span>;                        <span class="ActionScriptDefault_Text">_cameraVarsStore</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">cameraVarsStore</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">assignDynamic</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span> : <span class="ActionScriptDefault_Text">Object3D</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">leaf</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">mark</span> : <span class="ActionScriptDefault_Text">int</span>;                        <span class="ActionScriptDefault_Text">mark</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">child</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_sceneGraphMark</span>;            <span class="ActionScriptDefault_Text">leaf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">getLeafContaining</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptComment">// still in same leaf, no need to check anything</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">leaf</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">leaf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">leafId</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">mark</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mark</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span>                <span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">mark</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">removeChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">leaf</span><span class="ActionScriptBracket/Brace">)</span>                <span class="ActionScriptDefault_Text">leaf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">addChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * @inheritDoc         */</span>        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">addChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span> : <span class="ActionScriptDefault_Text">Object3D</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">super</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">addChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">_dynamics</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span> <span class="ActionScriptReserved">is</span> <span class="ActionScriptDefault_Text">Mesh</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptComment">//trace("is type Mesh");</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">_meshManagers</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">_meshManagers</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Dictionary</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">_meshManagers</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPMeshManager</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Mesh</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptComment">//trace("is not type Mesh");</span>                <span class="ActionScriptDefault_Text">child</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_sceneGraphMark</span> <span class="ActionScriptOperator">=</span> -1;    <span class="ActionScriptComment">//            if (child._collider) child._sceneGraphCollisionMarks = [];</span>                <span class="ActionScriptDefault_Text">assignDynamic</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">child</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Object3DEvent</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SCENETRANSFORM_CHANGED</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">onDynamicUpdate</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptASDoc">/**         * @inheritDoc         */</span>        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">removeChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span> : <span class="ActionScriptDefault_Text">Object3D</span><span class="ActionScriptBracket/Brace">)</span>  :<span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">try</span><span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">index</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_dynamics</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">indexOf</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span> <span class="ActionScriptOperator">&gt;=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">_dynamics</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">splice</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">index</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptReserved">super</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">removeChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">child</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_sceneGraphMark</span> <span class="ActionScriptOperator">=</span> -1;    <span class="ActionScriptComment">//            child._sceneGraphCollisionMarks = null;</span>                            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">child</span> <span class="ActionScriptReserved">is</span> <span class="ActionScriptDefault_Text">Mesh</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">_meshManagers</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">destroy</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">_meshManagers</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">child</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">child</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">removeEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Object3DEvent</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SCENETRANSFORM_CHANGED</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">onDynamicUpdate</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptBracket/Brace">}</span>                            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">catch</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">e</span>:<span class="ActionScriptDefault_Text">Error</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScripttrace">trace</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"BSPTRee error while trying removing a mesh"</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">onDynamicUpdate</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span> : <span class="ActionScriptDefault_Text">Object3DEvent</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>         <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptDefault_Text">assignDynamic</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Object3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">target</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptASDoc">/**         * @inheritDoc         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">override</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">traverse</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">traverser</span>:<span class="ActionScriptDefault_Text">Traverser</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptComment">// act normal</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">traverser</span> <span class="ActionScriptReserved">is</span> <span class="ActionScriptDefault_Text">ProjectionTraverser</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">traverser</span> <span class="ActionScriptReserved">is</span> <span class="ActionScriptDefault_Text">PrimitiveTraverser</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">super</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">traverse</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptReserved">return</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// matching PrimitiveTraverser on a BSPTree</span>            <span class="ActionScriptComment">// will cause update(_camera) to be called</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_complete</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">match</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptComment">// after apply, visList will be processed</span>                <span class="ActionScriptComment">// and most nodes won't need to be traversed</span>                   <span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">enter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;                   <span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">apply</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;                   <span class="ActionScriptComment">// send down for geom</span>                   <span class="ActionScriptDefault_Text">doTraverse</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptBracket/Brace">)</span>;                   <span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">leave</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptASDoc">/**         * Moves a Traverser object through the tree in the correct order to preserve z-sorting         */</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">doTraverse</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">traverser</span>:<span class="ActionScriptDefault_Text">Traverser</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">mesh</span> : <span class="ActionScriptDefault_Text">Mesh</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">first</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">second</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">isLeaf</span> : <span class="ActionScriptDefault_Text">Boolean</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">changed</span> : <span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">loopNode</span> : <span class="ActionScriptDefault_Text">BSPNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dictionary</span> : <span class="ActionScriptDefault_Text">Dictionary</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_cameraVarsStore</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">frustumDictionary</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">frustum</span> : <span class="ActionScriptDefault_Text">Frustum</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">dictionary</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">]</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">partitionPlane</span> : <span class="ActionScriptDefault_Text">Plane3D</span>;                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>;                        <span class="ActionScriptReserved">do</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">changed</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">isLeaf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span>;                                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">isLeaf</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">mesh</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_mesh</span>;                        <span class="ActionScriptDefault_Text">dictionary</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">frustum</span>;                                                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">match</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>                        <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">enter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">)</span>;                            <span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">apply</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">)</span>;                            <span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">leave</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptBracket/Brace">}</span>                                                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_hasChildren</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">traverseChildren</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">traverser</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptBracket/Brace">}</span>                                                <span class="ActionScriptComment">// temp</span><span class="ActionScriptComment">//                        if (    showPortals &amp;&amp; loopNode &amp;&amp;</span><span class="ActionScriptComment">//                                   loopNode._tempMesh &amp;&amp; </span><span class="ActionScriptComment">//                                   loopNode._tempMesh.extra &amp;&amp; </span><span class="ActionScriptComment">//                                   loopNode._tempMesh.extra.created</span><span class="ActionScriptComment">//                               ) loopNode._tempMesh.traverse(traverser);</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">renderMark</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_renderMark</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">partitionPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;                                                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_alignment</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">X_AXIS</span><span class="ActionScriptBracket/Brace">)</span>                                <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_lastIterationPositive</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">_transformPt</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span>;                            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_alignment</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Y_AXIS</span><span class="ActionScriptBracket/Brace">)</span>                                <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_lastIterationPositive</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">_transformPt</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span>;                            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_alignment</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Z_AXIS</span><span class="ActionScriptBracket/Brace">)</span>                                <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_lastIterationPositive</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">_transformPt</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span>;                            <span class="ActionScriptReserved">else</span>                                <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_lastIterationPositive</span> <span class="ActionScriptOperator">=</span>     <span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">_transformPt</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span>                                                                    <span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">_transformPt</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span>                                                                    <span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">_transformPt</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span>                                                                     <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">partitionPlane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span>;                        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_lastIterationPositive</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                            <span class="ActionScriptDefault_Text">second</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span>;                        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span>;                            <span class="ActionScriptDefault_Text">second</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                        <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>                                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">first</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">first</span>;                            <span class="ActionScriptDefault_Text">changed</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span>;                            <span class="ActionScriptDefault_Text">changed</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">second</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">second</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">second</span>;                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span>;                        <span class="ActionScriptDefault_Text">changed</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span>;                        <span class="ActionScriptDefault_Text">changed</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_lastIterationPositive</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">||</span>                        <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_lastIterationPositive</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span>;                    <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span>;                    <span class="ActionScriptDefault_Text">changed</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_rootNode</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * Performs early culling by processing the PVS and/or testing nodes against the frustum         */</span>         <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">doCulling</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">activeNode</span> : <span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">frustum</span> : <span class="ActionScriptDefault_Text">Frustum</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">len</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vislist</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">activeNode</span><span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">activeNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_visList</span> : <span class="ActionScriptReserved">null</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span> : <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span> : <span class="ActionScriptDefault_Text">int</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">leaf</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vislen</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">vislist</span><span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">vislist</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> : 0;                        <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                        <span class="ActionScriptComment">// process PVS</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">usePVS</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">vislen</span> <span class="ActionScriptOperator">==</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">len</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span>                       <span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">len</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">vislen</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">vislist</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">leaf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;                        <span class="ActionScriptDefault_Text">leaf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                        <span class="ActionScriptDefault_Text">leaf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_mesh</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_preCullClassification</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Frustum</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IN</span>;                        <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">j</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">leaf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;                        <span class="ActionScriptDefault_Text">leaf</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">activeNode</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">activeNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                        <span class="ActionScriptDefault_Text">propagateCulled</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">cullToFrustum</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">frustum</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * Bubbles up culled state to limit deep traversal         */</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">propagateCulled</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">pos</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">neg</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">loopNode</span> : <span class="ActionScriptDefault_Text">BSPNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span>;            <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>;                        <span class="ActionScriptReserved">do</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">pos</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span>;                <span class="ActionScriptDefault_Text">neg</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pos</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">pos</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">pos</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">neg</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">neg</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">neg</span>;                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span><span class="ActionScriptBracket/Brace">)</span>                            <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span>;                        <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">pos</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span>;                    <span class="ActionScriptDefault_Text">neg</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                    <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">pos</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">pos</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">neg</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">neg</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptBracket/Brace">}</span>                            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_rootNode</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * Iterates the tree and tests nodes against the frustum         */</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">cullToFrustum</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">frustum</span> : <span class="ActionScriptDefault_Text">Frustum</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">pos</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">neg</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">classification</span> : <span class="ActionScriptDefault_Text">int</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">needCheck</span> : <span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">loopNode</span> : <span class="ActionScriptDefault_Text">BSPNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span>;                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>;                        <span class="ActionScriptReserved">do</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">needCheck</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">classification</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">frustum</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">classifyAABB</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_bounds</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">classification</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Frustum</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">OUT</span><span class="ActionScriptBracket/Brace">)</span>;                                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_mesh</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_preCullClassification</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">classification</span>;<span class="ActionScriptComment">//                        if (!classification) loopNode._mesh.updateObject();</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptComment">// no further descension is needed if whole bounding box completely inside or outside frustum</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">classification</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">Frustum</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">INTERSECT</span><span class="ActionScriptBracket/Brace">)</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span>;                <span class="ActionScriptBracket/Brace">}</span>                                <span class="ActionScriptDefault_Text">pos</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span>;                <span class="ActionScriptDefault_Text">neg</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pos</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">pos</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">pos</span>;                        <span class="ActionScriptDefault_Text">needCheck</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span>;                        <span class="ActionScriptDefault_Text">needCheck</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">neg</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">neg</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_culled</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">neg</span>;                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_PRE</span>;                        <span class="ActionScriptDefault_Text">needCheck</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span>;                        <span class="ActionScriptDefault_Text">needCheck</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span><span class="ActionScriptBracket/Brace">)</span>                            <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TRAVERSE_IN</span>;                        <span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">loopNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_parent</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptDefault_Text">needCheck</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">loopNode</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_rootNode</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">_state</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">TRAVERSE_POST</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptDefault_Text">_preCullClassification</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Frustum</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">INTERSECT</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * Finalizes the tree. Must be called by build() or by custom parser         *         * @private         */</span>        <span class="ActionScriptComment">// Not liking the fact this this HAS to be called... Is an invalidation routine possible? - D</span>         <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">init</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>           <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_faces</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>                <span class="ActionScriptDefault_Text">_faces</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Face</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;                            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">j</span>:<span class="ActionScriptDefault_Text">int</span>;               <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">l</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;               <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">l</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span>               <span class="ActionScriptBracket/Brace">{</span>                   <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">=</span> 0;<span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">faces</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;<span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">_faces</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">faces</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptBracket/Brace">}</span>                       <span class="ActionScriptReserved">super</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">addChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_leaves</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptBracket/Brace">}</span>               <span class="ActionScriptBracket/Brace">}</span>               <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">propagateBounds</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">_maxX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_maxX</span>;            <span class="ActionScriptDefault_Text">_maxY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_maxY</span>;            <span class="ActionScriptDefault_Text">_maxZ</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_maxZ</span>;            <span class="ActionScriptDefault_Text">_minX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_minX</span>;            <span class="ActionScriptDefault_Text">_minY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_minY</span>;            <span class="ActionScriptDefault_Text">_minZ</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_minZ</span>;                        <span class="ActionScriptDefault_Text">notifyDimensionsChange</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">_complete</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;           <span class="ActionScriptBracket/Brace">}</span>                      <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_collisionDir</span> : <span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;           <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_collisionPlane</span> : <span class="ActionScriptDefault_Text">Plane3D</span>;           <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_collisionRatio</span> : <span class="ActionScriptDefault_Text">Number</span>;           <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_collidedObject</span> : <span class="ActionScriptDefault_Text">Object3D</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_planeStack</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_tMaxStack</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_tMinStack</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_nodeStack</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_bevelStack</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">&gt;</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">&gt;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_bevelNode</span> : <span class="ActionScriptDefault_Text">BSPNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_posNode</span> : <span class="ActionScriptDefault_Text">BSPNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_bevelNode</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptASDoc">/**         * Replaces the Material of a mesh by another one         * @param material                     The actual material applied, used to compare with the meshes fragments         * @param newMaterial                 The material that will replace the applied one         * @param clearPreviousMaterial  [optional] Clear previous material and nullifies it. Default is true. Note that eventual bitmapdata is NOT cleared.         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">replaceMaterial</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">material</span>:<span class="ActionScriptDefault_Text">Material</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">newMaterial</span>:<span class="ActionScriptDefault_Text">Material</span> <span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">clearPreviousMaterial</span>:<span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>         <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_faces</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>                <span class="ActionScriptReserved">return</span>;                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">loop</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_faces</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">oldmat</span>:<span class="ActionScriptDefault_Text">Material</span>;            <span class="ActionScriptReserved">for</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 0;<span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">&lt;</span><span class="ActionScriptDefault_Text">loop</span>;<span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_faces</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">material</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">material</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">oldmat</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span>                        <span class="ActionScriptDefault_Text">oldmat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_faces</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">material</span>;                                            <span class="ActionScriptDefault_Text">_faces</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">material</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newMaterial</span>;                <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">clearPreviousMaterial</span><span class="ActionScriptBracket/Brace">)</span>                <span class="ActionScriptDefault_Text">oldmat</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;        <span class="ActionScriptBracket/Brace">}</span>                   <span class="ActionScriptASDoc">/**         * Finds the closest colliding Face between start and end position         *          * @param start The starting position of the object (ie the object's current position)         * @param end The position the object is trying to reach         * @param radii The radii of the object's bounding eclipse         *          * @return The closest Face colliding with the object. Null if no collision was found.         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">traceCollision</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">start</span> : <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">end</span> : <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">testMethod</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">TEST_METHOD_POINT</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">halfExtents</span> : <span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">Boolean</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptDefault_Text">_collisionDir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">end</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;            <span class="ActionScriptDefault_Text">_collisionDir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">end</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;            <span class="ActionScriptDefault_Text">_collisionDir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">end</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span><span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">testMethod</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TEST_METHOD_POINT</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">findCollision</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">_collisionDir</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">testMethod</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                   <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">findCollision</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">_collisionDir</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">testMethod</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * The ratio [0, 1] on the movement line where the previous collision occurred         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">collisionRatio</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">Number</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_collisionRatio</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * The plane against which was collided during the last call to traceCollision         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">collisionPlane</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">Plane3D</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_collisionPlane</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         *          */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">collidedObject</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">Object3D</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_collidedObject</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptComment">// TO Do: need initial check to see if bounding box is not already colliding with geometry in start pos</span>         <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">findCollision</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">start</span> : <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">dir</span> : <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">testMethod</span> : <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">halfExtents</span> : <span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">tMin</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">tMax</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 1<span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">Boolean</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">plane</span> : <span class="ActionScriptDefault_Text">Plane3D</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">node</span> : <span class="ActionScriptDefault_Text">BSPNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_rootNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dirDot</span> : <span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dist</span> : <span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">t</span> : <span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">align</span> : <span class="ActionScriptDefault_Text">int</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">a</span> : <span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">b</span> : <span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">c</span> : <span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">d</span> : <span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">first</span> : <span class="ActionScriptDefault_Text">BSPNode</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">second</span> : <span class="ActionScriptDefault_Text">BSPNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">stackLen</span> : <span class="ActionScriptDefault_Text">int</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">splitPlane</span> : <span class="ActionScriptDefault_Text">Plane3D</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">offset</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ox</span> : <span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">oy</span> : <span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">oz</span> : <span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">queue</span> : <span class="ActionScriptDefault_Text">Boolean</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">oldMax</span> : <span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bevels</span> : <span class="ActionScriptDefault_Text">Vector</span><span class="ActionScriptBracket/Brace">.&lt;</span><span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptBracket/Brace">&gt;</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bevelIndex</span> : <span class="ActionScriptDefault_Text">int</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">colliders</span> : <span class="ActionScriptDefault_Text">Array</span>;                        <span class="ActionScriptDefault_Text">_bevelNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_posNode</span>;            <span class="ActionScriptDefault_Text">_posNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                        <span class="ActionScriptDefault_Text">_planeStack</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">_tMinStack</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">_tMaxStack</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">_nodeStack</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">_bevelStack</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">_collidedObject</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;                        <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptComment">// in a solid leaf, collision if colliding with bevel planes</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">node</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptComment">// dynamically insert bevel nodes if there are any, otherwise, reached a solid node</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">testMethod</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">BSPTree</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">TEST_METHOD_POINT</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">bevels</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">bevelIndex</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">bevels</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">_collisionPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">splitPlane</span>;                        <span class="ActionScriptDefault_Text">_collisionRatio</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tMin</span>;                        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;                    <span class="ActionScriptBracket/Brace">}</span>                                        <span class="ActionScriptDefault_Text">_bevelNode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bevels</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">bevelIndex</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">]</span>;                    <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_bevelNode</span>;                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptComment">// after all bevel checks, still in solid node</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">node</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">_collisionPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">splitPlane</span>;                    <span class="ActionScriptDefault_Text">_collisionRatio</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tMin</span>;                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;                <span class="ActionScriptBracket/Brace">}</span>                                <span class="ActionScriptComment">// "empty" leaf</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_isLeaf</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">colliders</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_colliders</span>;                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">colliders</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptDefault_Text">colliders</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">&gt;</span> 0 <span class="ActionScriptOperator">&amp;&amp;</span>                        <span class="ActionScriptDefault_Text">traceColliders</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">dir</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">tMin</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">tMax</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">testMethod</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">colliders</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>                            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;                                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">stackLen</span> <span class="ActionScriptOperator">==</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">_collisionPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;                        <span class="ActionScriptDefault_Text">_collisionRatio</span> <span class="ActionScriptOperator">=</span> 1;                        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptOperator">--</span><span class="ActionScriptDefault_Text">stackLen</span>;                    <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_nodeStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span>;                    <span class="ActionScriptDefault_Text">tMin</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_tMinStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span>;                    <span class="ActionScriptDefault_Text">tMax</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_tMaxStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span>;                    <span class="ActionScriptDefault_Text">splitPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_planeStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span>;                    <span class="ActionScriptDefault_Text">bevels</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_bevelStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span>;                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_bevelNode</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">bevels</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_bevelPlanes</span>;                        <span class="ActionScriptDefault_Text">bevelIndex</span> <span class="ActionScriptOperator">=</span> 0;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptDefault_Text">plane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;                    <span class="ActionScriptDefault_Text">align</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_alignment</span>;                    <span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span>;                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">align</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">X_AXIS</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span>;                        <span class="ActionScriptDefault_Text">dirDot</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">dir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;                        <span class="ActionScriptDefault_Text">dist</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">d</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">testMethod</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">TEST_METHOD_POINT</span><span class="ActionScriptBracket/Brace">)</span>                            <span class="ActionScriptDefault_Text">offset</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">align</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Y_AXIS</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span>;                        <span class="ActionScriptDefault_Text">dirDot</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">dir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;                        <span class="ActionScriptDefault_Text">dist</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">d</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">testMethod</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">TEST_METHOD_POINT</span><span class="ActionScriptBracket/Brace">)</span>                            <span class="ActionScriptDefault_Text">offset</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">align</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">Plane3D</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Z_AXIS</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span>;                        <span class="ActionScriptDefault_Text">dirDot</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">dir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span>;                        <span class="ActionScriptDefault_Text">dist</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">d</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">testMethod</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">TEST_METHOD_POINT</span><span class="ActionScriptBracket/Brace">)</span>                            <span class="ActionScriptDefault_Text">offset</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span>;                        <span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span>;                        <span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span>;                        <span class="ActionScriptDefault_Text">dirDot</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">dir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">dir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">dir</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span>;                        <span class="ActionScriptDefault_Text">dist</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">d</span>;                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">testMethod</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TEST_METHOD_AABB</span><span class="ActionScriptBracket/Brace">)</span>                            <span class="ActionScriptDefault_Text">offset</span> <span class="ActionScriptOperator">=</span>     <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> : <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span>                                        <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> : <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span>                                        <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">&gt;</span> 0<span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span> : <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">testMethod</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">TEST_METHOD_ELLIPSOID</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">ox</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">a</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span>;                            <span class="ActionScriptDefault_Text">oy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span>;                            <span class="ActionScriptDefault_Text">oz</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">c</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span>;                            <span class="ActionScriptDefault_Text">offset</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">sqrt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ox</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">ox</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">oy</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">oy</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">oz</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">oz</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptDefault_Text">dist</span> <span class="ActionScriptOperator">-=</span> <span class="ActionScriptDefault_Text">offset</span>;                    <span class="ActionScriptComment">// there has to be a way to use offset/dirDot to use bounds</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dirDot</span> <span class="ActionScriptOperator">!=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dirDot</span> <span class="ActionScriptOperator">&lt;</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span>;                            <span class="ActionScriptDefault_Text">second</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                            <span class="ActionScriptDefault_Text">second</span><span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span>;                        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// plane is between start point and segment end</span>                        <span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">dist</span><span class="ActionScriptOperator">/</span><span class="ActionScriptDefault_Text">dirDot</span>;                                                <span class="ActionScriptDefault_Text">oldMax</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">tMax</span>;                                                <span class="ActionScriptComment">// shift plane up</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">&gt;=</span> <span class="ActionScriptDefault_Text">tMin</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">tMax</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">tMax</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">t</span>;                            <span class="ActionScriptDefault_Text">queue</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;                        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptReserved">else</span> <span class="ActionScriptDefault_Text">queue</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;                                                <span class="ActionScriptComment">// shift plane down</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">&lt;=</span> <span class="ActionScriptDefault_Text">oldMax</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">queue</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                                <span class="ActionScriptComment">// splitting segment</span>                                <span class="ActionScriptDefault_Text">_nodeStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">second</span>;                                <span class="ActionScriptDefault_Text">_tMinStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">tMin</span> <span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">t</span> : <span class="ActionScriptDefault_Text">tMin</span>;                                <span class="ActionScriptDefault_Text">_tMaxStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">oldMax</span>;                                <span class="ActionScriptDefault_Text">_planeStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span>;                                <span class="ActionScriptDefault_Text">_bevelStack</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">stackLen</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bevels</span>;                                <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">stackLen</span>;                            <span class="ActionScriptBracket/Brace">}</span>                            <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                                <span class="ActionScriptDefault_Text">first</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">second</span>;                            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">first</span>;                    <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dist</span> <span class="ActionScriptOperator">&gt;=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_positiveNode</span>;                        <span class="ActionScriptReserved">else</span> <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;                    <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// this is never reached, but prevents compile error</span>            <span class="ActionScriptDefault_Text">_collisionPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">traceColliders</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">start</span> : <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">dir</span> : <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">tMin</span> : <span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">tMax</span> : <span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">testMethod</span> : <span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">halfExtents</span> : <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">colliders</span> : <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptDefault_Text">Boolean</span>         <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span> : <span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">colliders</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">collider</span> : <span class="ActionScriptDefault_Text">Object3D</span>;                        <span class="ActionScriptReserved">while</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">--</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&gt;=</span> 0<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">collider</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">colliders</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;                <span class="ActionScriptDefault_Text">updateCollisionTree</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">collider</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_obbCollisionTree</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">findCollision</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">start</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">dir</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">testMethod</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">halfExtents</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">tMin</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">tMax</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">_collisionPlane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_obbCollisionTree</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_collisionPlane</span>;                    <span class="ActionScriptDefault_Text">_collisionRatio</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_obbCollisionTree</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_collisionRatio</span>;                    <span class="ActionScriptDefault_Text">_collidedObject</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">collider</span>;                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">true</span>;                <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">false</span>;        <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptComment">// transform all bounding box planes to bsp coordinate system</span>        <span class="ActionScriptComment">// this can be improved by providing a transformation matrix in findCollision and do transforms at that point</span>        <span class="ActionScriptComment">// we just need to reset things here to object space</span>        <span class="ActionScriptComment">// or even better, assign a collisionTree instance to the collider (in dictionary)</span>        <span class="ActionScriptComment">// and only update on transformChange</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">updateCollisionTree</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">collider</span> : <span class="ActionScriptDefault_Text">Object3D</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">plane</span> : <span class="ActionScriptDefault_Text">Plane3D</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">node</span> : <span class="ActionScriptDefault_Text">BSPNode</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_obbCollisionTree</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_rootNode</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tr</span> : <span class="ActionScriptDefault_Text">Matrix3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Matrix3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">minX</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">collider</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">minX</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">maxX</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">collider</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_maxX</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">minY</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">collider</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_minY</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">maxY</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">collider</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_maxY</span>;             <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">minZ</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">collider</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_minZ</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">maxZ</span> : <span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">collider</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_maxZ</span>;            <span class="ActionScriptComment">// oh hi 0-thickness!</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minX</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">maxX</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">minX</span> <span class="ActionScriptOperator">-=</span> .5;                <span class="ActionScriptDefault_Text">maxX</span> <span class="ActionScriptOperator">+=</span> .5;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minY</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">maxY</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">minY</span> <span class="ActionScriptOperator">-=</span> .5;                <span class="ActionScriptDefault_Text">maxY</span> <span class="ActionScriptOperator">+=</span> .5;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">minZ</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">maxZ</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">minZ</span> <span class="ActionScriptOperator">-=</span> .5;                <span class="ActionScriptDefault_Text">maxZ</span> <span class="ActionScriptOperator">+=</span> .5;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptDefault_Text">tr</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">rawData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">collider</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transform</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">rawData</span>;            <span class="ActionScriptDefault_Text">tr</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">invert</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptComment">// front plane</span>            <span class="ActionScriptDefault_Text">plane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">=</span> -1;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">minZ</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transform</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tr</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;            <span class="ActionScriptComment">// back plane</span>            <span class="ActionScriptDefault_Text">plane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">=</span> 1;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">maxZ</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transform</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tr</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;            <span class="ActionScriptComment">// left plane</span>            <span class="ActionScriptDefault_Text">plane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">=</span> -1;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">minX</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transform</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tr</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;            <span class="ActionScriptComment">// right plane</span>            <span class="ActionScriptDefault_Text">plane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">=</span> 1;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">maxX</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transform</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tr</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;            <span class="ActionScriptComment">// top plane</span>            <span class="ActionScriptDefault_Text">plane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">=</span> 1;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">maxY</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transform</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tr</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">node</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_negativeNode</span>;            <span class="ActionScriptComment">// bottom plane</span>            <span class="ActionScriptDefault_Text">plane</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">node</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">_partitionPlane</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">a</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">c</span> <span class="ActionScriptOperator">=</span> 0;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">=</span> -1;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">minY</span>;            <span class="ActionScriptDefault_Text">plane</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">transform</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tr</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>         <span class="ActionScriptComment">// bsp build</span>        <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">addTemporaryChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mesh</span> : <span class="ActionScriptDefault_Text">Mesh</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">super</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">addChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptDefault_Text">arcane</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">removeTemporaryChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mesh</span> : <span class="ActionScriptDefault_Text">Mesh</span><span class="ActionScriptBracket/Brace">)</span> : <span class="ActionScriptReserved">void</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">super</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">removeChild</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mesh</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>    <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>
