<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>NormalBumpMaker.as</title>
<link rel="stylesheet" type="text/css" href="../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">materials</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">utils</span><span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">away3d</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">core</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;        <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">display</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">geom</span><span class="ActionScriptOperator">.</span><span class="ActionScriptOperator">*</span>;        <span class="ActionScriptASDoc">/**     * Utility class, principally to transform bump map data into normal map data. Can be used also to add bumps to an existing normal map.     *      * Additional numerically quick function to rotate the normals in a normal map by 90 or 180 degrees.     */</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">NormalBumpMaker</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">NormalBumpMaker</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>        <span class="ActionScriptBracket/Brace">}</span>         <span class="ActionScriptASDoc">/**         * Returns a positional vector for (ui, vi), taking into account bump map displacement.         * Calls external function if geometrical relationship known between (ui, vi) and (x, y, z)         *          * @param bumpMapData             BitmapData. The bumpmap bitmapdata;         * @param i                                 uint. pixel x position         * @param j                                 uint. pixel y position         * @param amplitude                     Number. Factor to scale the bumps.         * @param u                             Number. u coordinate.         * @param v                                 Number. v coordinate.         * @param geometryFunction         [optional] Function. Mapping function to convert from uv to xyz in real space          *         * @return A Vector3D for the position vector         *            */</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getPosition</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span>:<span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">amplitude</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">u</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">v</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">geometryFunction</span>:<span class="ActionScriptDefault_Text">Function</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bump</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">amplitude</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">getDisplacement</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">position</span>:<span class="ActionScriptDefault_Text">Vector3D</span>;            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">geometryFunction</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">geometryFunction</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">call</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">this</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">u</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">v</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bump</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">position</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">u</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">v</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bump</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">position</span>;        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptASDoc">/**         * Converts a pixel value into a displacement between 0 and 1. Assumes greyscale data so only uses the blue channel.         *          * @param bumpMapData             BitmapData. The bumpmap bitmapdata;         * @param i                     uint. pixel x position         * @param j                     uint. pixel y position         *         * @return A Number for the displacement size between 0 and 1         */</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getDisplacement</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span>:<span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">getPixel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;</span> 0xFF<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 255.0;        <span class="ActionScriptBracket/Brace">}</span>                                <span class="ActionScriptASDoc">/**         * Converts a pixel from raw normal map data into a normal vector.          *           * @param pixel                    unit: The pixel value containing normal vector data         *         * @return                         Vector3D: The normal vector                         *          */</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">convertToVector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pixel</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">x</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pixel</span> <span class="ActionScriptOperator">&amp;</span> 0xFF0000<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&gt;&gt;</span> 16<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 255.0 <span class="ActionScriptOperator">-</span> 0.5;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">y</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pixel</span> <span class="ActionScriptOperator">&amp;</span> 0x00FF00<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&gt;&gt;</span>  8<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 255.0 <span class="ActionScriptOperator">-</span> 0.5;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">z</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pixel</span> <span class="ActionScriptOperator">&amp;</span> 0x0000FF<span class="ActionScriptBracket/Brace">)</span>      <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 255.0 <span class="ActionScriptOperator">-</span> 0.5;                        <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">y</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">z</span><span class="ActionScriptBracket/Brace">)</span>;        <span class="ActionScriptBracket/Brace">}</span>        <span class="ActionScriptASDoc">/**         * Calculates normal from cross product between two vectors on the bump surface.         * Each vector on surface calculated from two positional vectors         *          * @param pvp1                    Number. Position vector a uv coordinate (u, v+1)          * @param pvm1                    Number. Position vector a uv coordinate (u, v-1)          * @param pup1                    Number. Position vector a uv coordinate (u+1, v)            * @param pum1                    Number. Position vector a uv coordinate (u-1, v)          *         * @return A Vector3D for the calculated normal vector         */</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">calculateNormal</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pvp1</span>:<span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">pvm1</span>:<span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">pup1</span>:<span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">pum1</span>:<span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptComment">// calculate directional vectors between the points</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vv</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">vv</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">pvp1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">subtract</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pvm1</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vu</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">vu</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">pup1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">subtract</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pum1</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptComment">// calculate normal from cross product. If the vectors are too small then</span>            <span class="ActionScriptComment">// just use an average of the positional vectors. This removes some badly </span>            <span class="ActionScriptComment">// calculated cross products.</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">normal</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">vu</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">&lt;</span> 0.001 <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">vv</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span> <span class="ActionScriptOperator">&lt;</span> 0.001<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">normal</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">pum1</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">add</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pup1</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">normal</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">add</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pvm1</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">normal</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">add</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pvp1</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">scaleBy</span><span class="ActionScriptBracket/Brace">(</span>0.25<span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">normal</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">vu</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">crossProduct</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">vv</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">normal</span>;        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptASDoc">/**         * Converts the calculated normal vector into RGB values and sets the pixel value.          * Takes into account different coordinate systems. For example "xyz" is traditional left-handed coordinate system         * "xzy" is a righthanded coordinate system (such as in Away3D)         *          * For a bump map on a plane, the first two axes are the u-v coordinates, the last being the displacement direction         *          * @param normalMapData         BitmapData. The normalmap bitmapdata;         * @param i                     uint. pixel x position         * @param j                     uint. pixel y position         * @param normal                 Vector3D. Calculated normal vector          * @param coordinates            String. Decides how pixel colours should be ordered          */</span>        <span class="ActionScriptReserved">protected</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">setNormal</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normalMapData</span>:<span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">normal</span>:<span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">coordinates</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">normalize</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">nx</span>:<span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ny</span>:<span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">nz</span>:<span class="ActionScriptDefault_Text">Number</span>;                        <span class="ActionScriptComment">// Map normal components from [-1, 1] to [0, 255]</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">coordinates</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">"xyz"</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">nx</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">/</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 0.5;                <span class="ActionScriptDefault_Text">ny</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">/</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 0.5;                <span class="ActionScriptDefault_Text">nz</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span> <span class="ActionScriptOperator">/</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 0.5;                            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">coordinates</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptString">"xzy"</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">nx</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">/</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 0.5;                <span class="ActionScriptDefault_Text">ny</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span> <span class="ActionScriptOperator">/</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 0.5;                <span class="ActionScriptDefault_Text">nz</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">/</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 0.5;                            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptComment">// ensure that vectors are within limits            </span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">nx</span> <span class="ActionScriptOperator">&gt;</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">nx</span> <span class="ActionScriptOperator">=</span> 1;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">ny</span> <span class="ActionScriptOperator">&gt;</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">ny</span> <span class="ActionScriptOperator">=</span> 1;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">nz</span> <span class="ActionScriptOperator">&gt;</span> 1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">nz</span> <span class="ActionScriptOperator">=</span> 1;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// Set components into RGB pixel values</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">color</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">nx</span><span class="ActionScriptOperator">*</span>0xFF <span class="ActionScriptOperator">&lt;&lt;</span> 16 <span class="ActionScriptOperator">|</span> <span class="ActionScriptDefault_Text">ny</span><span class="ActionScriptOperator">*</span>0xFF <span class="ActionScriptOperator">&lt;&lt;</span> 8 <span class="ActionScriptOperator">|</span> <span class="ActionScriptDefault_Text">nz</span><span class="ActionScriptOperator">*</span>0xFF;                        <span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">setPixel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">color</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * Method to change normal directions by 90 or 180 degrees so that, for example, a normal map created for a plane in the         * xy plane can be used in an xz plane for which the rotation produces a mapping (x, y, z) -&gt; (x, z, -y)         *          * Quick method: rather than recalculating the normals just modify the red, green and blue channels of the normal map data.         * In the above example, the blue channel is copied to the green channel.         *          * To account for vector components which are negated we use a inverted bitmap (255 - original value). In the above example         * we copy the inverted green channel to the blue channel.          *          *         * @param sourceData             BitmapData. The source bitmapdata;         * @param redSource             [optional] uint. The uint representing the red channel. Default is BitmapDataChannel.RED.         * @param greenSource             [optional] uint. The uint representing the green channel. Default BitmapDataChannel.GREEN.         * @param blueSource             [optional] uint. The uint representing the blue channel. Default BitmapDataChannel.BLUE.         * @param invertRed             [optional] Boolean. If the red channel needs to be inverted. Default false.         * @param invertGreen             [optional] Boolean. If the green channel needs to be inverted. Default false.         * @param invertBlue             [optional] Boolean. If the blue channel needs to be inverted. Default false.         *         * @return A bitmapdata for the rotated normal map         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">convertNormalChannels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sourceData</span>:<span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">redSource</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">greenSource</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>2<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">blueSource</span>:<span class="ActionScriptDefault_Text">uint</span><span class="ActionScriptOperator">=</span>4<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">invertRed</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">invertGreen</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">invertBlue</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">BitmapData</span>        <span class="ActionScriptBracket/Brace">{</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">width</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">sourceData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">height</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">sourceData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rect</span>:<span class="ActionScriptDefault_Text">Rectangle</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">point</span>:<span class="ActionScriptDefault_Text">Point</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptComment">// Create new bitmapData for return result</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">destData</span>:<span class="ActionScriptDefault_Text">BitmapData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> 0x000000<span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptComment">// Create an inverted bitmap (255-value) for all channels if needed</span>            <span class="ActionScriptComment">// This is needed if we want a particular vector component to be negated</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">inverseSourceData</span>:<span class="ActionScriptDefault_Text">BitmapData</span>;            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">invertRed</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">invertGreen</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">invertBlue</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">inverseSourceData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> 0xFFFFFF<span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">inverseSourceData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sourceData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">rect</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">point</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">inverseSourceData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">draw</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Bitmap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> 0x000000<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">BlendMode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">INVERT</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// Copy destination vector component to red channel, negating if necessary</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">invertRed</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">destData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyChannel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">inverseSourceData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">redSource</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">BitmapDataChannel</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">RED</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">destData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyChannel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sourceData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">redSource</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">BitmapDataChannel</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">RED</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// Copy destination vector component to green channel, negating if necessary</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">invertGreen</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">destData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyChannel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">inverseSourceData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">greenSource</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">BitmapDataChannel</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">GREEN</span><span class="ActionScriptBracket/Brace">)</span>;                            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">destData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyChannel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sourceData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">greenSource</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">BitmapDataChannel</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">GREEN</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// Copy destination vector component to blue channel, negating if necessary</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">invertBlue</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">destData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyChannel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">inverseSourceData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">blueSource</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">BitmapDataChannel</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">BLUE</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">destData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyChannel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sourceData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">blueSource</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">BitmapDataChannel</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">BLUE</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">destData</span>;                <span class="ActionScriptBracket/Brace">}</span>                <span class="ActionScriptASDoc">/**         * Add bumps to a normal Map. Bumps are initially converted to normal vectors (assuming that they are on a plane originally) and         * then a rotation is applied to align them with the original normal map data.         *          * @param normalMapData                BitmapData. Original normal map.         * @param bumpMapData                BitmapData. Original bump map.         * @param amplitude                    [optional] Number. Amplitude of bumps. Default is 0.05         * @param uRepeat                     [optional] Boolean. If the U coordinate should be repeated. Default false;         * @param vRepeat                     [optional] Boolean. If the V coordinate should be repeated. Default false;         * @return                             BitmapData. Bumps applied to normal map.         *          */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">addBumpsToNormalMap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normalMapData</span>:<span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bumpMapData</span>:<span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">amplitude</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">=</span>0.05<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">uRepeat</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">vRepeat</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">BitmapData</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptComment">// scale the bump map data to the same dimensions as the normal map data. </span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">newBumpData</span>:<span class="ActionScriptDefault_Text">BitmapData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> 0x00000<span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">matrix</span>:<span class="ActionScriptDefault_Text">Matrix</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Matrix</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">matrix</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">scale</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">newBumpData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">draw</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">matrix</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">BlendMode</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">NORMAL</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">newBumpData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">clone</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptComment">// Convert the bump map data to normal map. For simplicity ignores the geometry function, assumes bumps are on a plane </span>            <span class="ActionScriptComment">// in the xy direction. </span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bumpNormalData</span>:<span class="ActionScriptDefault_Text">BitmapData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">convertToNormalMap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">newBumpData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">amplitude</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">uRepeat</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">vRepeat</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptString">"xyz"</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptComment">// defines the zaxis vector</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">zAxis</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptComment">// loop over normal map data. Calculate rotation necessary to align bumps correctly.</span>            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">j</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                                        <span class="ActionScriptComment">// convert normal map (pixel) data into vector data</span>                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">baseNormal</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">convertToVector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">getPixel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bumpNormal</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">convertToVector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpNormalData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">getPixel</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                                        <span class="ActionScriptComment">// Calculate rotation matrix necessary to rotate the zaxis onto the normal.</span>                    <span class="ActionScriptComment">// First of all calcualte axis of rotation from cross product of normal and zaxis</span>                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rotationAxis</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">zAxis</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">crossProduct</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">baseNormal</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptComment">// determine angle of rotation</span>                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">theta</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Vector3DUtils</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">getAngle</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">baseNormal</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">zAxis</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptComment">// Create rotation matrix.</span>                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rotationMatrix</span>:<span class="ActionScriptDefault_Text">Matrix3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Matrix3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">rotationMatrix</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">appendRotation</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">theta</span><span class="ActionScriptOperator">*</span>180<span class="ActionScriptOperator">/</span><span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">PI</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Vector3D</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rotationAxis</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">x</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">rotationAxis</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">y</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">rotationAxis</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">z</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                                        <span class="ActionScriptComment">// Apply rotation matrix to bump map normal</span>                    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">correctedBump</span>:<span class="ActionScriptDefault_Text">Vector3D</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">rotationMatrix</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">deltaTransformVector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpNormal</span><span class="ActionScriptBracket/Brace">)</span>;                                        <span class="ActionScriptComment">// Store the bump normal, mapped to the original normal, in the bitmap data</span>                    <span class="ActionScriptDefault_Text">setNormal</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpNormalData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">correctedBump</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptString">"xyz"</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span>                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">bumpNormalData</span>;        <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptASDoc">/**         * Function to convert bump map displacements into a normal map         *          * Calculations are performed to calculate the vectors on the original bump map and from these the          * normal is obtained.          *          * Conversion utility allows for a geometrical function to map from the (u, v) coordinates of the bump map         * to (x, y, z) coordinates of a particular model. The amplitude of the bump can also be specified with relation         * to the maximum u and v values of the bumpmap (being equal to 1). If the bump map has repeated boundaries (for         * example with a sphere or torus) this can be specified as well.         *          * By default bump displacements are assumed to be in the "y" direction (for planes) but this can be specifying         * a coordinate value, for example "xyz" assumes u and v are in the x and y direction, displacements in the z.         *          * For example, for a sphere the geometry function would be:         *          *         public function convertToSpherical(ui:Number, vi:Number, disp:Number):Vector3D {         *            var theta:Number = ui * 2 * Math.PI;         *            var phi:Number = vi * Math.PI;         *            var p:Vector3D = new Vector3D(Math.cos(theta)*Math.sin(phi), Math.sin(theta)*Math.sin(phi), Math.cos(phi));         *             *            var pScaled:Vector3D = new Vector3D();         *            pScaled.scale(p, 1 + disp);         *             *            return pScaled;         *        }         *          * The call to create a spherical normal map with bump map data having a max amplitude of 0.1, that is          * repeated along the u direction would be:         *          *         convertToNormal(bumpMapData, convertToSpherical, 0.1, true, false);         *         *         * @param bumpMapData             BitmapData. The bitmapdata with the bump information.         * @param geometryFunction         [optional] Function. The geometrical function to apply. Default null.         * @param amplitude             [optional] Number. The amount of amplitude. Default 0.05.         * @param uRepeat                 [optional] Boolean. If the U coordinate should be repeated. Default false;         * @param vRepeat                 [optional] Boolean. If the V coordinate should be repeated. Default false;         * @param coordinates             [optional] String. Decides how pixel colours should be ordered. Default "xzy";         *         * @return A bitmapdata         */</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">convertToNormalMap</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span>:<span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">geometryFunction</span>:<span class="ActionScriptDefault_Text">Function</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">amplitude</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">=</span>0.05<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">uRepeat</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">vRepeat</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">coordinates</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">"xzy"</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">BitmapData</span> <span class="ActionScriptBracket/Brace">{</span>                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptReserved">return</span> <span class="ActionScriptReserved">null</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">ui</span>  :<span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">uim1</span>:<span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">uip1</span>:<span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vi</span>  :<span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vim1</span>:<span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vip1</span>:<span class="ActionScriptDefault_Text">Number</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">p_uivim1</span>:<span class="ActionScriptDefault_Text">Vector3D</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">p_uivip1</span>:<span class="ActionScriptDefault_Text">Vector3D</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">p_uim1vi</span>:<span class="ActionScriptDefault_Text">Vector3D</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">p_uip1vi</span>:<span class="ActionScriptDefault_Text">Vector3D</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">normal</span>:<span class="ActionScriptDefault_Text">Vector3D</span>;                        <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">width</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span>;            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">height</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span>;                        <span class="ActionScriptComment">// Create new bitmap data to store normal map</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">normalMapData</span>:<span class="ActionScriptDefault_Text">BitmapData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> 0x000000<span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptComment">// Copy bump map into a larger bitmap data so that we can more easily account for boundary conditions</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">extendedBumpMapData</span>:<span class="ActionScriptDefault_Text">BitmapData</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">+</span>2<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">+</span>2<span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">false</span><span class="ActionScriptOperator">,</span> 0xFFFFFF<span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                        <span class="ActionScriptComment">// Copy the left and right edges to the opposite sides if bump map is repeated in the u direction</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">uRepeat</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// Copy the top and bottom edges to the opposite sides if bump map is repeated in the v direction</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">vRepeat</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>                <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptOperator">,</span> 0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">copyPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Rectangle</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">width</span><span class="ActionScriptOperator">,</span> 1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">height</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;            <span class="ActionScriptBracket/Brace">}</span>                        <span class="ActionScriptComment">// Calculate normals over entire surface</span>            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">width</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                                <span class="ActionScriptDefault_Text">ui</span>   <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">uim1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptDefault_Text">uip1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;                                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">j</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">height</span>; <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>                    <span class="ActionScriptDefault_Text">vi</span>   <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">height</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">vim1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">height</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">vip1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">height</span> <span class="ActionScriptOperator">-</span> 1<span class="ActionScriptBracket/Brace">)</span>;                                        <span class="ActionScriptComment">// Get positional vectors for points around position (ui, vi)</span>                    <span class="ActionScriptDefault_Text">p_uivim1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">getPosition</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">amplitude</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">ui</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">vim1</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">geometryFunction</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">p_uivip1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">getPosition</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">+</span>2<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">amplitude</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">ui</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">vip1</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">geometryFunction</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">p_uim1vi</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">getPosition</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span>  <span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">amplitude</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">uim1</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">vi</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">geometryFunction</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptDefault_Text">p_uip1vi</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">getPosition</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">extendedBumpMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">+</span>2<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">+</span>1<span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">amplitude</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">uip1</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">vi</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">geometryFunction</span><span class="ActionScriptBracket/Brace">)</span>;                    <span class="ActionScriptComment">// Calculate normal from positional vectors</span>                    <span class="ActionScriptDefault_Text">normal</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">calculateNormal</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">p_uivip1</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">p_uivim1</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">p_uip1vi</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">p_uim1vi</span><span class="ActionScriptBracket/Brace">)</span>;                                        <span class="ActionScriptComment">// set the pixel in the normal map data taking into account the coordinate systems</span>                    <span class="ActionScriptDefault_Text">setNormal</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">normalMapData</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">normal</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">coordinates</span><span class="ActionScriptBracket/Brace">)</span>;                <span class="ActionScriptBracket/Brace">}</span>                            <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">normalMapData</span>;        <span class="ActionScriptBracket/Brace">}</span>            <span class="ActionScriptBracket/Brace">}</span><span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>
